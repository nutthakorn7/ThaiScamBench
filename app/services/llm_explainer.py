"""Enhanced LLM explainer with structured JSON prompts"""
from typing import Tuple
import json

# Category translations
CATEGORY_TRANSLATIONS = {
    'fake_officer': 'à¹à¸­à¸šà¸­à¹‰à¸²à¸‡à¹€à¸›à¹‡à¸™à¹€à¸ˆà¹‰à¸²à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆ',
    'parcel_scam': 'à¸«à¸¥à¸­à¸à¸¥à¸§à¸‡à¸žà¸±à¸ªà¸”à¸¸',
    'loan_scam': 'à¸«à¸¥à¸­à¸à¸à¸¹à¹‰à¹€à¸‡à¸´à¸™',
    'investment_scam': 'à¸«à¸¥à¸­à¸à¸¥à¸‡à¸—à¸¸à¸™',
    'otp_phishing': 'à¸‚à¸­à¸£à¸«à¸±à¸ª OTP',
    'marketplace_scam': 'à¸«à¸¥à¸­à¸à¸‚à¸²à¸¢à¸‚à¸­à¸‡à¸­à¸­à¸™à¹„à¸¥à¸™à¹Œ',
    'other_scam': 'à¸à¸²à¸£à¸«à¸¥à¸­à¸à¸¥à¸§à¸‡à¸­à¸·à¹ˆà¸™à¹†',
    'normal': 'à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸›à¸à¸•à¸´'
}

# Structured explanations for each category
CATEGORY_EXPLANATIONS = {
    'fake_officer': {
        'reason': 'à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸¡à¸µà¸¥à¸±à¸à¸©à¸“à¸°à¹à¸­à¸šà¸­à¹‰à¸²à¸‡à¹€à¸›à¹‡à¸™à¹€à¸ˆà¹‰à¸²à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆ à¸žà¸šà¸„à¸³à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡à¸à¸±à¸šà¸«à¸™à¹ˆà¸§à¸¢à¸‡à¸²à¸™à¸£à¸²à¸Šà¸à¸²à¸£ à¸•à¸³à¸£à¸§à¸ˆ à¸«à¸£à¸·à¸­à¸¨à¸²à¸¥ à¹€à¸žà¸·à¹ˆà¸­à¸ªà¸£à¹‰à¸²à¸‡à¸„à¸§à¸²à¸¡à¸™à¹ˆà¸²à¹€à¸Šà¸·à¹ˆà¸­à¸–à¸·à¸­à¹à¸¥à¸°à¸à¸”à¸”à¸±à¸™à¹ƒà¸«à¹‰à¸«à¸¥à¸‡à¹€à¸Šà¸·à¹ˆà¸­',
        'advice': 'ðŸš« à¹€à¸ˆà¹‰à¸²à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¸ˆà¸£à¸´à¸‡à¸ˆà¸°à¹„à¸¡à¹ˆà¸•à¸´à¸”à¸•à¹ˆà¸­à¸œà¹ˆà¸²à¸™ SMS à¸«à¸£à¸·à¸­ LINE\nâš ï¸ à¸­à¸¢à¹ˆà¸²à¹‚à¸­à¸™à¹€à¸‡à¸´à¸™à¸«à¸£à¸·à¸­à¹ƒà¸«à¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¹ˆà¸§à¸™à¸•à¸±à¸§\nâœ… à¸•à¸´à¸”à¸•à¹ˆà¸­à¸«à¸™à¹ˆà¸§à¸¢à¸‡à¸²à¸™à¸—à¸µà¹ˆà¸­à¹‰à¸²à¸‡à¸–à¸¶à¸‡à¹‚à¸”à¸¢à¸•à¸£à¸‡\nðŸ“ž à¹‚à¸—à¸£à¸ªà¸­à¸šà¸–à¸²à¸¡à¸—à¸µà¹ˆà¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚à¸£à¸²à¸Šà¸à¸²à¸£à¸ˆà¸£à¸´à¸‡'
    },
    'parcel_scam': {
        'reason': 'à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸¡à¸µà¸¥à¸±à¸à¸©à¸“à¸°à¸‚à¸­à¸‡à¸à¸²à¸£à¹à¸­à¸šà¸­à¹‰à¸²à¸‡à¹€à¸›à¹‡à¸™à¸šà¸£à¸´à¸©à¸±à¸—à¸‚à¸™à¸ªà¹ˆà¸‡ à¸žà¸šà¸„à¸³à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡à¸à¸±à¸š "à¸žà¸±à¸ªà¸”à¸¸", "à¸„à¹‰à¸²à¸‡à¸Šà¸³à¸£à¸°", "à¸„à¹ˆà¸²à¸˜à¸£à¸£à¸¡à¹€à¸™à¸µà¸¢à¸¡" à¹à¸¥à¸°à¸¡à¸µà¸¥à¸´à¸‡à¸à¹Œà¸—à¸µà¹ˆà¸™à¹ˆà¸²à¸ªà¸‡à¸ªà¸±à¸¢ à¸‹à¸¶à¹ˆà¸‡à¹€à¸›à¹‡à¸™à¸£à¸¹à¸›à¹à¸šà¸šà¸à¸²à¸£à¸«à¸¥à¸­à¸à¸¥à¸§à¸‡à¸—à¸µà¹ˆà¸žà¸šà¸šà¹ˆà¸­à¸¢à¹ƒà¸™à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™',
        'advice': 'ðŸš« à¹„à¸¡à¹ˆà¸„à¸§à¸£à¸„à¸¥à¸´à¸à¸¥à¸´à¸‡à¸à¹Œà¹ƒà¸”à¹† à¹ƒà¸™à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡\nâš ï¸ à¹„à¸¡à¹ˆà¸„à¸§à¸£à¹ƒà¸«à¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¹ˆà¸§à¸™à¸•à¸±à¸§à¸«à¸£à¸·à¸­à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸šà¸±à¸•à¸£à¹€à¸„à¸£à¸”à¸´à¸•\nâœ… à¸«à¸²à¸à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š à¸„à¸§à¸£à¸•à¸´à¸”à¸•à¹ˆà¸­à¸šà¸£à¸´à¸©à¸±à¸—à¸‚à¸™à¸ªà¹ˆà¸‡à¹‚à¸”à¸¢à¸•à¸£à¸‡à¸œà¹ˆà¸²à¸™à¸Šà¹ˆà¸­à¸‡à¸—à¸²à¸‡à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸›à¹‡à¸™à¸—à¸²à¸‡à¸à¸²à¸£\nâœ… à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹€à¸¥à¸‚à¸žà¸±à¸ªà¸”à¸¸à¸œà¹ˆà¸²à¸™à¹à¸­à¸›à¸žà¸¥à¸´à¹€à¸„à¸Šà¸±à¸™à¸«à¸£à¸·à¸­à¹€à¸§à¹‡à¸šà¹„à¸‹à¸•à¹Œà¸«à¸¥à¸±à¸à¸‚à¸­à¸‡à¸šà¸£à¸´à¸©à¸±à¸—'
    },
    'loan_scam': {
        'reason': 'à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸¡à¸µà¸¥à¸±à¸à¸©à¸“à¸°à¹€à¸ªà¸™à¸­à¸ªà¸´à¸™à¹€à¸Šà¸·à¹ˆà¸­à¸«à¸£à¸·à¸­à¹€à¸‡à¸´à¸™à¸à¸¹à¹‰à¸—à¸µà¹ˆà¸”à¸¹à¸‡à¹ˆà¸²à¸¢à¹€à¸à¸´à¸™à¹„à¸› à¸žà¸šà¸„à¸³à¹€à¸Šà¹ˆà¸™ "à¸à¸¹à¹‰à¸”à¹ˆà¸§à¸™", "à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸„à¹‰à¸³", "à¹„à¸¡à¹ˆà¹€à¸Šà¹‡à¸„à¹€à¸„à¸£à¸”à¸´à¸•" à¸‹à¸¶à¹ˆà¸‡à¸¡à¸±à¸à¹€à¸›à¹‡à¸™à¸à¸¥à¸¥à¸§à¸‡à¹ƒà¸«à¹‰à¹‚à¸­à¸™à¸„à¹ˆà¸²à¸˜à¸£à¸£à¸¡à¹€à¸™à¸µà¸¢à¸¡à¸«à¸£à¸·à¸­à¸„à¹ˆà¸²à¸¡à¸±à¸”à¸ˆà¸³à¸à¹ˆà¸­à¸™',
        'advice': 'ðŸš« à¸­à¸¢à¹ˆà¸²à¹€à¸Šà¸·à¹ˆà¸­à¸ªà¸´à¸™à¹€à¸Šà¸·à¹ˆà¸­à¸—à¸µà¹ˆà¸­à¸™à¸¸à¸¡à¸±à¸•à¸´à¸‡à¹ˆà¸²à¸¢à¸œà¸´à¸”à¸›à¸à¸•à¸´\nâš ï¸ à¸­à¸¢à¹ˆà¸²à¹‚à¸­à¸™à¹€à¸‡à¸´à¸™à¸„à¹ˆà¸²à¸˜à¸£à¸£à¸¡à¹€à¸™à¸µà¸¢à¸¡à¸¥à¹ˆà¸§à¸‡à¸«à¸™à¹‰à¸²\nâœ… à¸à¸¹à¹‰à¹€à¸‡à¸´à¸™à¸à¸±à¸šà¸ªà¸–à¸²à¸šà¸±à¸™à¸à¸²à¸£à¹€à¸‡à¸´à¸™à¸—à¸µà¹ˆà¸–à¸¹à¸à¸à¸Žà¸«à¸¡à¸²à¸¢à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™\nðŸ“ž à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹ƒà¸šà¸­à¸™à¸¸à¸à¸²à¸•à¸à¸±à¸šà¸˜à¸™à¸²à¸„à¸²à¸£à¹à¸«à¹ˆà¸‡à¸›à¸£à¸°à¹€à¸—à¸¨à¹„à¸—à¸¢'
    },
    'investment_scam': {
        'reason': 'à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹€à¸ªà¸™à¸­à¹‚à¸­à¸à¸²à¸ªà¸¥à¸‡à¸—à¸¸à¸™à¸—à¸µà¹ˆà¹ƒà¸«à¹‰à¸œà¸¥à¸•à¸­à¸šà¹à¸—à¸™à¸ªà¸¹à¸‡à¸œà¸´à¸”à¸›à¸à¸•à¸´ à¸žà¸šà¸„à¸³à¹€à¸Šà¹ˆà¸™ "à¸£à¸§à¸¢à¹€à¸£à¹‡à¸§", "à¸à¸³à¹„à¸£à¸¡à¸²à¸", "à¸¥à¸‡à¸—à¸¸à¸™à¸™à¹‰à¸­à¸¢" à¸‹à¸¶à¹ˆà¸‡à¹€à¸›à¹‡à¸™à¸ªà¸±à¸à¸à¸²à¸“à¹€à¸•à¸·à¸­à¸™à¸‚à¸­à¸‡à¹€à¸‡à¸´à¸™à¸¥à¸‡à¸—à¸¸à¸™à¸«à¸¥à¸­à¸à¸¥à¸§à¸‡',
        'advice': 'ðŸš« à¸£à¸°à¸§à¸±à¸‡à¸‚à¹‰à¸­à¹€à¸ªà¸™à¸­à¸¥à¸‡à¸—à¸¸à¸™à¸—à¸µà¹ˆà¹ƒà¸«à¹‰à¸œà¸¥à¸•à¸­à¸šà¹à¸—à¸™à¸ªà¸¹à¸‡à¸œà¸´à¸”à¸›à¸à¸•à¸´\nâš ï¸ à¹„à¸¡à¹ˆà¸¡à¸µà¸à¸²à¸£à¸¥à¸‡à¸—à¸¸à¸™à¸—à¸µà¹ˆà¸£à¸±à¸šà¸›à¸£à¸°à¸à¸±à¸™à¸à¸³à¹„à¸£ 100%\nâœ… à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹ƒà¸šà¸­à¸™à¸¸à¸à¸²à¸•à¸à¸±à¸š à¸.à¸¥.à¸•.\nâœ… à¸¨à¸¶à¸à¸©à¸²à¸„à¸§à¸²à¸¡à¹€à¸ªà¸µà¹ˆà¸¢à¸‡à¸à¹ˆà¸­à¸™à¸¥à¸‡à¸—à¸¸à¸™à¹€à¸ªà¸¡à¸­'
    },
    'otp_phishing': {
        'reason': 'à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸žà¸¢à¸²à¸¢à¸²à¸¡à¸«à¸¥à¸­à¸à¹ƒà¸«à¹‰à¹à¸ˆà¹‰à¸‡à¸£à¸«à¸±à¸ª OTP à¸«à¸£à¸·à¸­à¸£à¸«à¸±à¸ªà¸¢à¸·à¸™à¸¢à¸±à¸™à¸•à¸±à¸§à¸•à¸™ à¸‹à¸¶à¹ˆà¸‡à¹€à¸›à¹‡à¸™à¸§à¸´à¸˜à¸µà¸à¸²à¸£à¹‚à¸ˆà¸£à¸à¸£à¸£à¸¡à¸šà¸±à¸à¸Šà¸µà¸—à¸µà¹ˆà¸žà¸šà¸šà¹ˆà¸­à¸¢ à¸¡à¸±à¸à¸­à¹‰à¸²à¸‡à¸§à¹ˆà¸²à¸šà¸±à¸à¸Šà¸µà¸¡à¸µà¸›à¸±à¸à¸«à¸²à¸«à¸£à¸·à¸­à¸•à¹‰à¸­à¸‡à¸¢à¸·à¸™à¸¢à¸±à¸™à¸•à¸±à¸§à¸•à¸™',
        'advice': 'ðŸš« à¸«à¹‰à¸²à¸¡à¹à¸ˆà¹‰à¸‡à¸£à¸«à¸±à¸ª OTP à¹ƒà¸«à¹‰à¹ƒà¸„à¸£à¸—à¸¸à¸à¸à¸£à¸“à¸µ\nâš ï¸ à¸˜à¸™à¸²à¸„à¸²à¸£à¹„à¸¡à¹ˆà¸¡à¸µà¸—à¸²à¸‡à¸‚à¸­à¸£à¸«à¸±à¸ª OTP à¸ˆà¸²à¸à¸„à¸¸à¸“\nâœ… à¸£à¸«à¸±à¸ª OTP à¹ƒà¸Šà¹‰à¹€à¸‰à¸žà¸²à¸°à¸„à¸¸à¸“à¹€à¸žà¸·à¹ˆà¸­à¸¢à¸·à¸™à¸¢à¸±à¸™à¸˜à¸¸à¸£à¸à¸£à¸£à¸¡à¸‚à¸­à¸‡à¸•à¸±à¸§à¹€à¸­à¸‡\nðŸ“ž à¸«à¸²à¸à¸ªà¸‡à¸ªà¸±à¸¢à¹‚à¸—à¸£à¸˜à¸™à¸²à¸„à¸²à¸£à¸—à¸±à¸™à¸—à¸µ'
    },
    'marketplace_scam': {
        'reason': 'à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸¡à¸µà¸¥à¸±à¸à¸©à¸“à¸°à¸à¸²à¸£à¸‚à¸²à¸¢à¸ªà¸´à¸™à¸„à¹‰à¸²à¸­à¸­à¸™à¹„à¸¥à¸™à¹Œà¸—à¸µà¹ˆà¸™à¹ˆà¸²à¸ªà¸‡à¸ªà¸±à¸¢ à¸¡à¸±à¸à¹€à¸£à¹ˆà¸‡à¸£à¸±à¸”à¹ƒà¸«à¹‰à¹‚à¸­à¸™à¹€à¸‡à¸´à¸™à¸à¹ˆà¸­à¸™ à¸­à¸²à¸ˆà¹€à¸ªà¸™à¸­à¸£à¸²à¸„à¸²à¸–à¸¹à¸à¸œà¸´à¸”à¸›à¸à¸•à¸´ à¸«à¸£à¸·à¸­à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸¡à¸±à¸”à¸ˆà¸³ à¸‹à¸¶à¹ˆà¸‡à¹€à¸›à¹‡à¸™à¸£à¸¹à¸›à¹à¸šà¸šà¸à¸²à¸£à¸«à¸¥à¸­à¸à¸¥à¸§à¸‡à¹ƒà¸™à¸à¸²à¸£à¸‹à¸·à¹‰à¸­à¸‚à¸²à¸¢à¸­à¸­à¸™à¹„à¸¥à¸™à¹Œ',
        'advice': 'ðŸš« à¸­à¸¢à¹ˆà¸²à¹‚à¸­à¸™à¹€à¸‡à¸´à¸™à¸à¹ˆà¸­à¸™à¹€à¸«à¹‡à¸™à¸‚à¸­à¸‡à¸ˆà¸£à¸´à¸‡\nâš ï¸ à¸£à¸°à¸§à¸±à¸‡à¸£à¸²à¸„à¸²à¸–à¸¹à¸à¸œà¸´à¸”à¸›à¸à¸•à¸´à¸«à¸£à¸·à¸­à¹€à¸£à¹ˆà¸‡à¸£à¸±à¸”à¹ƒà¸«à¹‰à¸•à¸±à¸”à¸ªà¸´à¸™à¹ƒà¸ˆ\nâœ… à¹ƒà¸Šà¹‰à¸£à¸°à¸šà¸šà¸Šà¸³à¸£à¸°à¹€à¸‡à¸´à¸™à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢à¸‚à¸­à¸‡à¹à¸žà¸¥à¸•à¸Ÿà¸­à¸£à¹Œà¸¡\nâœ… à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸£à¸µà¸§à¸´à¸§à¹à¸¥à¸°à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸œà¸¹à¹‰à¸‚à¸²à¸¢'
    },
    'other_scam': {
        'reason': 'à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸¡à¸µà¸¥à¸±à¸à¸©à¸“à¸°à¸™à¹ˆà¸²à¸ªà¸‡à¸ªà¸±à¸¢à¸—à¸µà¹ˆà¸­à¸²à¸ˆà¹€à¸›à¹‡à¸™à¸à¸²à¸£à¸«à¸¥à¸­à¸à¸¥à¸§à¸‡à¸£à¸¹à¸›à¹à¸šà¸šà¸­à¸·à¹ˆà¸™ à¸žà¸šà¸ªà¸±à¸à¸à¸²à¸“à¹€à¸•à¸·à¸­à¸™à¸«à¸¥à¸²à¸¢à¸›à¸£à¸°à¸à¸²à¸£ à¹à¸•à¹ˆà¹„à¸¡à¹ˆà¸ˆà¸±à¸”à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¸›à¸£à¸°à¹€à¸ à¸—à¸«à¸¥à¸±à¸',
        'advice': 'ðŸš« à¸£à¸°à¸¡à¸±à¸”à¸£à¸°à¸§à¸±à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸—à¸µà¹ˆà¸‚à¸­à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¹ˆà¸§à¸™à¸•à¸±à¸§à¸«à¸£à¸·à¸­à¹€à¸‡à¸´à¸™\nâš ï¸ à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸„à¸§à¸²à¸¡à¸™à¹ˆà¸²à¹€à¸Šà¸·à¹ˆà¸­à¸–à¸·à¸­à¸‚à¸­à¸‡à¸œà¸¹à¹‰à¸ªà¹ˆà¸‡\nâœ… à¸«à¸²à¸à¸ªà¸‡à¸ªà¸±à¸¢ à¸­à¸¢à¹ˆà¸²à¸£à¸µà¸šà¸•à¸­à¸šà¸à¸¥à¸±à¸šà¸«à¸£à¸·à¸­à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£à¹ƒà¸”à¹†\nðŸ“ž à¸ªà¸­à¸šà¸–à¸²à¸¡à¸œà¸¹à¹‰à¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸à¸«à¸£à¸·à¸­à¸«à¸™à¹ˆà¸§à¸¢à¸‡à¸²à¸™à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡'
    },
    'normal': {
        'reason': 'à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸¡à¸µà¸¥à¸±à¸à¸©à¸“à¸°à¸›à¸à¸•à¸´ à¹„à¸¡à¹ˆà¸žà¸šà¸ªà¸±à¸à¸à¸²à¸“à¸‚à¸­à¸‡à¸à¸²à¸£à¸«à¸¥à¸­à¸à¸¥à¸§à¸‡à¸—à¸µà¹ˆà¸Šà¸±à¸”à¹€à¸ˆà¸™ à¸­à¸¢à¹ˆà¸²à¸‡à¹„à¸£à¸à¹‡à¸•à¸²à¸¡à¸„à¸§à¸£à¸£à¸°à¸¡à¸±à¸”à¸£à¸°à¸§à¸±à¸‡à¸à¸±à¸šà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¸„à¸¸à¹‰à¸™à¹€à¸„à¸¢à¹€à¸ªà¸¡à¸­',
        'advice': 'âœ… à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸™à¸µà¹‰à¸”à¸¹à¸›à¸à¸•à¸´ à¹à¸•à¹ˆà¸¢à¸±à¸‡à¸„à¸‡à¸•à¹‰à¸­à¸‡à¸£à¸°à¸¡à¸±à¸”à¸£à¸°à¸§à¸±à¸‡\nâš ï¸ à¸­à¸¢à¹ˆà¸²à¹ƒà¸«à¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¹ˆà¸§à¸™à¸•à¸±à¸§à¸à¸±à¸šà¸„à¸™à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¸£à¸¹à¹‰à¸ˆà¸±à¸\nâš ï¸ à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸¥à¸´à¸‡à¸à¹Œà¸à¹ˆà¸­à¸™à¸„à¸¥à¸´à¸à¸—à¸¸à¸à¸„à¸£à¸±à¹‰à¸‡\nðŸ“š à¸¨à¸¶à¸à¸©à¸²à¸£à¸¹à¸›à¹à¸šà¸šà¸à¸²à¸£à¸«à¸¥à¸­à¸à¸¥à¸§à¸‡à¹ƒà¸«à¸¡à¹ˆà¹† à¸­à¸¢à¸¹à¹ˆà¹€à¸ªà¸¡à¸­'
    }
}


def explain_with_llm(message: str, category: str) -> Tuple[str, str]:
    """
    Generate explanation using structured template
    
    Args:
        message: The message text
        category: Detected category
        
    Returns:
        Tuple of (reason, advice)
    """
    # Get explanation for category
    explanation = CATEGORY_EXPLANATIONS.get(category, CATEGORY_EXPLANATIONS['other_scam'])
    
    return explanation['reason'], explanation['advice']


def parse_llm_json_response(response: str) -> dict:
    """
    Parse LLM response as JSON with fallback
    
    Args:
        response: Raw LLM response
        
    Returns:
        Parsed dictionary
    """
    try:
        # Try direct JSON parsing
        return json.loads(response)
    except json.JSONDecodeError:
        # Fallback: try to extract JSON from text
        import re
        json_match = re.search(r'\{.*\}', response, re.DOTALL)
        if json_match:
            try:
                return json.loads(json_match.group())
            except:
                pass
        
        # Ultimate fallback: return error
        return {
            'error': 'Failed to parse LLM response',
            'raw_response': response
        }


# Structured prompt template for real LLM integration
LLM_PROMPT_TEMPLATE = """
à¸„à¸¸à¸“à¹€à¸›à¹‡à¸™à¸£à¸°à¸šà¸šà¸•à¸£à¸§à¸ˆà¸ˆà¸±à¸šà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸«à¸¥à¸­à¸à¸¥à¸§à¸‡à¸ à¸²à¸©à¸²à¹„à¸—à¸¢

à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸•à¹ˆà¸­à¹„à¸›à¸™à¸µà¹‰à¹à¸¥à¸°à¸•à¸­à¸šà¹€à¸›à¹‡à¸™ JSON à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™:

à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡: {message}
à¸›à¸£à¸°à¹€à¸ à¸—à¸—à¸µà¹ˆà¸•à¸£à¸§à¸ˆà¸žà¸š: {category}

à¸•à¸­à¸šà¹ƒà¸™à¸£à¸¹à¸›à¹à¸šà¸š JSON à¸™à¸µà¹‰à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™ (à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸¡à¸µà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸­à¸·à¹ˆà¸™):
{{
  "is_scam": true/false,
  "risk_score": 0.0-1.0,
  "category": "{category}",
  "reason": "à¸„à¸³à¸­à¸˜à¸´à¸šà¸²à¸¢à¸ à¸²à¸©à¸²à¹„à¸—à¸¢",
  "advice": "à¸„à¸³à¹à¸™à¸°à¸™à¸³à¸ à¸²à¸©à¸²à¹„à¸—à¸¢"
}}
"""


class LLMExplainerInterface:
    """
    Interface for plugging in real LLM services
    
    Future implementations should:
    1. Call OpenAI/Claude/Gemini API
    2. Use structured prompt template
    3. Parse JSON response
    4. Handle errors gracefully
    """
    
    def explain(self, message: str, category: str) -> Tuple[str, str]:
        """
        Generate explanation for detection
        
        Args:
            message: Message text
            category: Detected category
            
        Returns:
            (reason, advice) tuple
        """
        return explain_with_llm(message, category)
    
    def get_prompt(self, message: str, category: str) -> str:
        """Get formatted prompt for LLM"""
        return LLM_PROMPT_TEMPLATE.format(message=message, category=category)

"""
Mock Explainer Implementation

Provides template-based explanations for scam detection results.
In production, this can be replaced with LLM-based explanations.
"""
import logging
from typing import Dict

from app.services.interfaces.explainer import IExplainer, ExplanationResult
from app.core.exceptions import ServiceError

logger = logging.getLogger(__name__)


# Thai explanation templates by category
EXPLANATION_TEMPLATES = {
    "parcel_scam": {
        "reason": "à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸¡à¸µà¸¥à¸±à¸à¸©à¸“à¸°à¸‚à¸­à¸‡à¸à¸²à¸£à¹à¸­à¸šà¸­à¹‰à¸²à¸‡à¹€à¸›à¹‡à¸™à¸šà¸£à¸´à¸©à¸±à¸—à¸‚à¸™à¸ªà¹ˆà¸‡ à¸žà¸šà¸„à¸³à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡à¸à¸±à¸š \"à¸žà¸±à¸ªà¸”à¸¸\", \"à¸„à¹‰à¸²à¸‡à¸Šà¸³à¸£à¸°\", \"à¸„à¹ˆà¸²à¸˜à¸£à¸£à¸¡à¹€à¸™à¸µà¸¢à¸¡\" à¹à¸¥à¸°à¸¡à¸µà¸¥à¸´à¸‡à¸à¹Œà¸—à¸µà¹ˆà¸™à¹ˆà¸²à¸ªà¸‡à¸ªà¸±à¸¢ à¸‹à¸¶à¹ˆà¸‡à¹€à¸›à¹‡à¸™à¸£à¸¹à¸›à¹à¸šà¸šà¸à¸²à¸£à¸«à¸¥à¸­à¸à¸¥à¸§à¸‡à¸—à¸µà¹ˆà¸žà¸šà¸šà¹ˆà¸­à¸¢à¹ƒà¸™à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™",
        "advice": "ðŸš« à¹„à¸¡à¹ˆà¸„à¸§à¸£à¸„à¸¥à¸´à¸à¸¥à¸´à¸‡à¸à¹Œà¹ƒà¸”à¹† à¹ƒà¸™à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡\nâš ï¸ à¹„à¸¡à¹ˆà¸„à¸§à¸£à¹ƒà¸«à¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¹ˆà¸§à¸™à¸•à¸±à¸§à¸«à¸£à¸·à¸­à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸šà¸±à¸•à¸£à¹€à¸„à¸£à¸”à¸´à¸•\nâœ… à¸«à¸²à¸à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š à¸„à¸§à¸£à¸•à¸´à¸”à¸•à¹ˆà¸­à¸šà¸£à¸´à¸©à¸±à¸—à¸‚à¸™à¸ªà¹ˆà¸‡à¹‚à¸”à¸¢à¸•à¸£à¸‡à¸œà¹ˆà¸²à¸™à¸Šà¹ˆà¸­à¸‡à¸—à¸²à¸‡à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸›à¹‡à¸™à¸—à¸²à¸‡à¸à¸²à¸£\nâœ… à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹€à¸¥à¸‚à¸žà¸±à¸ªà¸”à¸¸à¸œà¹ˆà¸²à¸™à¹à¸­à¸›à¸žà¸¥à¸´à¹€à¸„à¸Šà¸±à¸™à¸«à¸£à¸·à¸­à¹€à¸§à¹‡à¸šà¹„à¸‹à¸•à¹Œà¸«à¸¥à¸±à¸à¸‚à¸­à¸‡à¸šà¸£à¸´à¸©à¸±à¸—"
    },
    "banking_scam": {
        "reason": "à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸¡à¸µà¸¥à¸±à¸à¸©à¸“à¸°à¸à¸²à¸£à¹à¸­à¸šà¸­à¹‰à¸²à¸‡à¸˜à¸™à¸²à¸„à¸²à¸£ à¸žà¸šà¸„à¸³à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡à¸à¸±à¸š \"OTP\", \"à¸£à¸«à¸±à¸ª\", \"à¸¢à¸·à¸™à¸¢à¸±à¸™à¸•à¸±à¸§à¸•à¸™\" à¸«à¸£à¸·à¸­ \"à¸šà¸±à¸à¸Šà¸µà¸–à¸¹à¸à¸£à¸°à¸‡à¸±à¸š\" à¸‹à¸¶à¹ˆà¸‡à¹€à¸›à¹‡à¸™à¹€à¸—à¸„à¸™à¸´à¸„à¸—à¸µà¹ˆà¸™à¸±à¸à¸•à¹‰à¸¡à¸•à¸¸à¹‹à¸™à¹ƒà¸Šà¹‰à¸«à¸¥à¸­à¸à¹ƒà¸«à¹‰à¹€à¸«à¸¢à¸·à¹ˆà¸­à¸ªà¹ˆà¸‡à¸£à¸«à¸±à¸ª OTP à¸«à¸£à¸·à¸­à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡à¸šà¸±à¸à¸Šà¸µ",
        "advice": "ðŸš« à¹„à¸¡à¹ˆà¸„à¸§à¸£à¹ƒà¸«à¹‰à¸£à¸«à¸±à¸ª OTP à¸à¸±à¸šà¹ƒà¸„à¸£à¸—à¸²à¸‡à¹‚à¸—à¸£à¸¨à¸±à¸žà¸—à¹Œà¸«à¸£à¸·à¸­à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡\nâš ï¸ à¸˜à¸™à¸²à¸„à¸²à¸£à¸ˆà¸£à¸´à¸‡à¸ˆà¸°à¹„à¸¡à¹ˆà¸‚à¸­à¸£à¸«à¸±à¸ª OTP à¸—à¸²à¸‡ SMS\nâœ… à¸«à¸²à¸à¸ªà¸‡à¸ªà¸±à¸¢ à¸„à¸§à¸£à¹‚à¸—à¸£à¸•à¸´à¸”à¸•à¹ˆà¸­à¸˜à¸™à¸²à¸„à¸²à¸£à¹‚à¸”à¸¢à¸•à¸£à¸‡à¸œà¹ˆà¸²à¸™à¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¸”à¹‰à¸²à¸™à¸«à¸¥à¸±à¸‡à¸šà¸±à¸•à¸£ ATM\nâœ… à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸šà¸±à¸à¸Šà¸µà¸œà¹ˆà¸²à¸™ Mobile Banking à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸›à¹‡à¸™à¸—à¸²à¸‡à¸à¸²à¸£"
    },
    "prize_scam": {
        "reason": "à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹à¸ˆà¹‰à¸‡à¸§à¹ˆà¸²à¸„à¸¸à¸“à¸–à¸¹à¸à¸£à¸²à¸‡à¸§à¸±à¸¥ à¹‚à¸”à¸¢à¸¡à¸µà¸„à¸³à¹€à¸Šà¹ˆà¸™ \"à¸¢à¸´à¸™à¸”à¸µà¸”à¹‰à¸§à¸¢\", \"à¹‚à¸Šà¸„à¸”à¸µ\", \"à¸Šà¸™à¸°à¸£à¸²à¸‡à¸§à¸±à¸¥\" à¹à¸¥à¸°à¸‚à¸­à¹ƒà¸«à¹‰à¸Šà¸³à¸£à¸°à¸„à¹ˆà¸²à¸˜à¸£à¸£à¸¡à¹€à¸™à¸µà¸¢à¸¡à¸«à¸£à¸·à¸­à¸„à¸¥à¸´à¸à¸¥à¸´à¸‡à¸à¹Œ à¹€à¸›à¹‡à¸™à¸£à¸¹à¸›à¹à¸šà¸šà¸à¸²à¸£à¸«à¸¥à¸­à¸à¸¥à¸§à¸‡à¸—à¸µà¹ˆà¸žà¸šà¸šà¹ˆà¸­à¸¢",
        "advice": "ðŸš« à¸£à¸²à¸‡à¸§à¸±à¸¥à¸ˆà¸£à¸´à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸à¸²à¸£à¹€à¸£à¸µà¸¢à¸à¹€à¸à¹‡à¸šà¸„à¹ˆà¸²à¸˜à¸£à¸£à¸¡à¹€à¸™à¸µà¸¢à¸¡\nâš ï¸ à¹„à¸¡à¹ˆà¸„à¸§à¸£à¹‚à¸­à¸™à¹€à¸‡à¸´à¸™à¸«à¸£à¸·à¸­à¹ƒà¸«à¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¹ˆà¸§à¸™à¸•à¸±à¸§\nâœ… à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸à¸±à¸šà¸šà¸£à¸´à¸©à¸±à¸—à¸«à¸£à¸·à¸­à¸«à¸™à¹ˆà¸§à¸¢à¸‡à¸²à¸™à¹‚à¸”à¸¢à¸•à¸£à¸‡\nâœ… à¸£à¸°à¸§à¸±à¸‡à¸¥à¸´à¸‡à¸à¹Œà¸›à¸¥à¸­à¸¡à¸—à¸µà¹ˆà¸­à¸²à¸ˆà¸‚à¹‚à¸¡à¸¢à¸‚à¹‰à¸­à¸¡à¸¹à¸¥"
    },
    "investment_scam": {
        "reason": "à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹€à¸ªà¸™à¸­à¸à¸²à¸£à¸¥à¸‡à¸—à¸¸à¸™à¸—à¸µà¹ˆà¸¡à¸µà¸œà¸¥à¸•à¸­à¸šà¹à¸—à¸™à¸ªà¸¹à¸‡à¸œà¸´à¸”à¸›à¸à¸•à¸´ à¸¡à¸µà¸„à¸³à¹€à¸Šà¹ˆà¸™ \"à¸£à¸§à¸¢à¹€à¸£à¹‡à¸§\", \"à¸à¸³à¹„à¸£à¹à¸™à¹ˆà¸™à¸­à¸™\", \"à¸£à¸±à¸šà¸›à¸£à¸°à¸à¸±à¸™à¸œà¸¥à¸•à¸­à¸šà¹à¸—à¸™\" à¸‹à¸¶à¹ˆà¸‡à¹€à¸›à¹‡à¸™à¸ªà¸±à¸à¸à¸²à¸“à¹€à¸•à¸·à¸­à¸™à¸‚à¸­à¸‡à¸à¸²à¸£à¸¥à¸‡à¸—à¸¸à¸™à¸‰à¹‰à¸­à¹‚à¸à¸‡",
        "advice": "ðŸš« à¹„à¸¡à¹ˆà¸¡à¸µà¸à¸²à¸£à¸¥à¸‡à¸—à¸¸à¸™à¸—à¸µà¹ˆà¸£à¸±à¸šà¸›à¸£à¸°à¸à¸±à¸™à¸à¸³à¹„à¸£à¹à¸™à¹ˆà¸™à¸­à¸™\nâš ï¸ à¸£à¸°à¸§à¸±à¸‡à¸‚à¹‰à¸­à¹€à¸ªà¸™à¸­à¸—à¸µà¹ˆà¸”à¸µà¹€à¸à¸´à¸™à¸ˆà¸£à¸´à¸‡\nâœ… à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹ƒà¸šà¸­à¸™à¸¸à¸à¸²à¸•à¸‚à¸­à¸‡à¸šà¸£à¸´à¸©à¸±à¸—à¸à¸±à¸š à¸.à¸¥.à¸•.\nâœ… à¸›à¸£à¸¶à¸à¸©à¸²à¸œà¸¹à¹‰à¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸à¸à¹ˆà¸­à¸™à¸•à¸±à¸”à¸ªà¸´à¸™à¹ƒà¸ˆà¸¥à¸‡à¸—à¸¸à¸™"
    },
    "impersonation_scam": {
        "reason": "à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹à¸­à¸šà¸­à¹‰à¸²à¸‡à¹€à¸›à¹‡à¸™à¹€à¸ˆà¹‰à¸²à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¸£à¸±à¸ à¹€à¸Šà¹ˆà¸™ à¸•à¸³à¸£à¸§à¸ˆ, DSI, à¸à¸£à¸¡à¸ªà¸£à¸£à¸žà¸²à¸à¸£ à¹‚à¸”à¸¢à¸­à¹‰à¸²à¸‡à¸§à¹ˆà¸²à¸¡à¸µà¸„à¸”à¸µà¸«à¸£à¸·à¸­à¸›à¸±à¸à¸«à¸²à¸—à¸²à¸‡à¸à¸Žà¸«à¸¡à¸²à¸¢ à¹à¸¥à¸°à¸‚à¸­à¹ƒà¸«à¹‰à¹‚à¸­à¸™à¹€à¸‡à¸´à¸™à¸«à¸£à¸·à¸­à¹ƒà¸«à¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥",
        "advice": "ðŸš« à¹€à¸ˆà¹‰à¸²à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¸ˆà¸£à¸´à¸‡à¸ˆà¸°à¹„à¸¡à¹ˆà¹€à¸£à¸µà¸¢à¸à¹€à¸à¹‡à¸šà¹€à¸‡à¸´à¸™à¸—à¸²à¸‡à¹‚à¸—à¸£à¸¨à¸±à¸žà¸—à¹Œà¸«à¸£à¸·à¸­ SMS\nâš ï¸ à¹„à¸¡à¹ˆà¸¡à¸µà¸à¸²à¸£à¸›à¸£à¸°à¸à¸±à¸™à¸•à¸±à¸§à¸œà¹ˆà¸²à¸™à¸à¸²à¸£à¹‚à¸­à¸™à¹€à¸‡à¸´à¸™\nâœ… à¸•à¸´à¸”à¸•à¹ˆà¸­à¸«à¸™à¹ˆà¸§à¸¢à¸‡à¸²à¸™à¹‚à¸”à¸¢à¸•à¸£à¸‡à¹€à¸žà¸·à¹ˆà¸­à¸¢à¸·à¸™à¸¢à¸±à¸™\nâœ… à¹à¸ˆà¹‰à¸‡à¸„à¸§à¸²à¸¡à¸«à¸²à¸à¸–à¸¹à¸à¸‚à¹ˆà¸¡à¸‚à¸¹à¹ˆ"
    },
    "loan_scam": {
        "reason": "à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹€à¸ªà¸™à¸­à¸ªà¸´à¸™à¹€à¸Šà¸·à¹ˆà¸­à¸—à¸µà¹ˆà¸­à¸™à¸¸à¸¡à¸±à¸•à¸´à¸‡à¹ˆà¸²à¸¢ à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸„à¹‰à¸³ à¸”à¸­à¸à¹€à¸šà¸µà¹‰à¸¢ 0% à¹‚à¸”à¸¢à¹„à¸¡à¹ˆà¸œà¹ˆà¸²à¸™à¸ªà¸–à¸²à¸šà¸±à¸™à¸à¸²à¸£à¹€à¸‡à¸´à¸™à¸—à¸µà¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡ à¸­à¸²à¸ˆà¹€à¸›à¹‡à¸™à¸à¸¥à¸¸à¹ˆà¸¡à¹€à¸‡à¸´à¸™à¸à¸¹à¹‰à¸™à¸­à¸à¸£à¸°à¸šà¸š",
        "advice": "ðŸš« à¸£à¸°à¸§à¸±à¸‡à¹€à¸‡à¸´à¸™à¸à¸¹à¹‰à¸™à¸­à¸à¸£à¸°à¸šà¸šà¸—à¸µà¹ˆà¸¡à¸µà¸”à¸­à¸à¹€à¸šà¸µà¹‰à¸¢à¸ªà¸¹à¸‡à¸¥à¸±à¸šà¸«à¸¥à¸±à¸‡\nâš ï¸ à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹ƒà¸šà¸­à¸™à¸¸à¸à¸²à¸•à¸‚à¸­à¸‡à¸œà¸¹à¹‰à¹ƒà¸«à¹‰à¸à¸¹à¹‰à¸à¸±à¸šà¸˜à¸™à¸²à¸„à¸²à¸£à¹à¸«à¹ˆà¸‡à¸›à¸£à¸°à¹€à¸—à¸¨à¹„à¸—à¸¢\nâœ… à¹ƒà¸Šà¹‰à¸šà¸£à¸´à¸à¸²à¸£à¸ªà¸´à¸™à¹€à¸Šà¸·à¹ˆà¸­à¸ˆà¸²à¸à¸ªà¸–à¸²à¸šà¸±à¸™à¸à¸²à¸£à¹€à¸‡à¸´à¸™à¸—à¸µà¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™\nâœ… à¸­à¹ˆà¸²à¸™à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸ªà¸±à¸à¸à¸²à¹ƒà¸«à¹‰à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”"
    },
    "safe": {
        "reason": "à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸™à¸µà¹‰à¸”à¸¹à¹€à¸«à¸¡à¸·à¸­à¸™à¸›à¸à¸•à¸´ à¹„à¸¡à¹ˆà¸žà¸šà¸ªà¸±à¸à¸à¸²à¸“à¸‚à¸­à¸‡à¸à¸²à¸£à¸«à¸¥à¸­à¸à¸¥à¸§à¸‡à¸—à¸µà¹ˆà¸Šà¸±à¸”à¹€à¸ˆà¸™",
        "advice": "âœ… à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸”à¸¹à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢\nâš ï¸ à¹à¸•à¹ˆà¸„à¸§à¸£à¸£à¸°à¸¡à¸±à¸”à¸£à¸°à¸§à¸±à¸‡à¹€à¸ªà¸¡à¸­ à¸­à¸¢à¹ˆà¸²à¹ƒà¸«à¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¹ˆà¸§à¸™à¸•à¸±à¸§à¸«à¸²à¸à¹„à¸¡à¹ˆà¹à¸™à¹ˆà¹ƒà¸ˆ\nâœ… à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸œà¸¹à¹‰à¸ªà¹ˆà¸‡à¹ƒà¸«à¹‰à¹à¸™à¹ˆà¹ƒà¸ˆà¸à¹ˆà¸­à¸™à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£à¹ƒà¸”à¹†"
    }
}


class MockExplainer(IExplainer):
    """
    Template-based explainer for scam detection
    
    Provides pre-written Thai explanations based on detected category.
    Fast and reliable, but less flexible than LLM-based explanations.
    """
    
    def __init__(self):
        self._provider = "mock"
        self._version = "v1.0"
        logger.info(f"Initialized {self._provider} explainer {self._version}")
    
    @property
    def provider(self) -> str:
        return self._provider
    
    def get_version(self) -> str:
        return self._version
    
    async def explain(
        self,
        message: str,
        category: str,
        risk_score: float,
        is_scam: bool
    ) -> ExplanationResult:
        """
        Generate explanation using templates
        
        Args:
            message: Original message (not used in mock, PDPA safe)
            category: Detected category
            risk_score: Risk score
            is_scam: Whether classified as scam
            
        Returns:
            ExplanationResult with reason and advice
        """
        try:
            logger.debug(f"Generating explanation for category: {category}")
            
            # Get template for category (fallback to safe)
            template = EXPLANATION_TEMPLATES.get(
                category,
                EXPLANATION_TEMPLATES["safe"]
            )
            
            reason = template["reason"]
            advice = template["advice"]
            
            # Add risk level context
            if is_scam and risk_score >= 0.8:
                reason = f"âš ï¸ à¸„à¸§à¸²à¸¡à¹€à¸ªà¸µà¹ˆà¸¢à¸‡à¸ªà¸¹à¸‡! {reason}"
            elif is_scam and risk_score >= 0.5:
                reason = f"âš ï¸ à¸„à¸§à¸²à¸¡à¹€à¸ªà¸µà¹ˆà¸¢à¸‡à¸›à¸²à¸™à¸à¸¥à¸²à¸‡. {reason}"
            
            return ExplanationResult(
                reason=reason,
                advice=advice,
                confidence=1.0,  # Template-based, always confident
                llm_used=False
            )
            
        except Exception as e:
            logger.error(f"Explanation generation error: {e}", exc_info=True)
            raise ServiceError(f"Failed to generate explanation: {str(e)}")


# Factory function
def get_explainer() -> IExplainer:
    """Get mock explainer instance"""
    return MockExplainer()


# Legacy async function for backward compatibility
async def generate_explanation(
    category: str,
    risk_score: float,
    message: str = ""
) -> Dict[str, str]:
    """
    Legacy explanation function (deprecated - use MockExplainer instead)
    
    Kept for backward compatibility.
    """
    explainer = get_explainer()
    is_scam = risk_score >= 0.5 and category != "safe"
    result = await explainer.explain(message, category, risk_score, is_scam)
    return {
        "reason": result.reason,
        "advice": result.advice
    }
